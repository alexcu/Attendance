{% extends "layout.html" %}
{% block content %}
    <h1>Timetable Clashes</h1>
    {{ msg }}
    <div class="row">
        <div class="col-md-12">
            <table class="table" id="clashes">
                <thead>
                <td>Student ID</td>
                <td>Name</td>
                <td>Timeslot</td>
                <td>Subjects</td>
                </thead>


            </table>
        </div>
    </div>

    <div class="row">
        <h1>Subjects At Risk</h1>
    <div class ="col-md-12">
        Please choose a recent average attendance rate for "at risk" classes: <input type="number" value="3"
                                                                                     id="atriskattendancerate"/>
        <button class="button" type="button" onclick="updateDataTable()">Update</button>
        <table class="table" id="atrisk">
                <thead>
                <td>Subject Code</td>
                <td>Subject Name</td>
                <td>Recent Average Attendance</td>
                </thead>


            </table>
    </div>
    </div>

    <div class="row">
        <h1>Non-Attending</h1>
        <div class="col-md-12">
            <table class="table" id="nonattending">
                <thead>
                <td>Student Name</td>
                <td>Subject Name</td>
                </thead>


            </table>
        </div>
    </div>


    <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.15/css/jquery.dataTables.css">

    <script>

        $(document).ready(function () {
            $('#clashes').DataTable({
                "ajax": {
                    "url": '/viewclashesajax',
                    "type": 'GET'
                },
                "columns": [{
                    "data": "studentcode", "render": function (data, type, row, meta) {
                        return row.student.studentcode
                    }
                }, {
                    "data": "name", "render": function (data, type, row, meta) {
                        return "<a href='/viewstudent%3Fstudentcode%3D" + row.student.studentcode + "'>" + row.student.name + "</a>";
                    }
                }, {
                    "data": "timeslot", "render": function (data, type, row, meta) {
                        return row.timeslot.day + " " + row.timeslot.time;
                    }
                },
                    {
                        "data": "subjects", "render": function (data, type, row, meta) {
                        var str = "";
                        for (i = 0; i < row.subjects.length; i++) {
                            str += row.subjects[i] + "<br>"
                            console.log(str)

                        }
                        return str
                    }
                    }]
            });

            datatable = $('#atrisk').DataTable({
                "ajax": {
                    "url": '/getatriskclassesajax',
                    "data": {
                        averageattendancerate: function (d) {
                            return document.getElementById('atriskattendancerate').value
                        }
                    },
                    "type": 'POST'
                },
                "columns": [{
                    "data": "subcode"
                }, {
                    "data": "subcode", "render": function (data, type, row, meta) {
                        return "<a href='/subject%3Fsubcode%3D" + row.subcode + "'>" + row.subname + "</a>";
                    }
                }, {
                    "data": "recentaverageattendance"
                }]
            });


            $('#nonattending').DataTable({
                "ajax": {
                    "url": '/getnonattendingstudentsajax',
                    "type": 'GET'
                },
                "columns": [{
                    "data": "name", "render": function (data, type, row, meta) {
                        return "<a href='/viewstudent%3Fstudentcode%3D" + row.studentcode + "'>" + row.name + "</a>";
                    }
                }, {
                    "data": "subcode", "render": function (data, type, row, meta) {
                        return "<a href='/subject%3Fsubcode%3D" + row.subcode + "'>" + row.subname + "</a>";
                    }
                }]
            });
        });

        function updateDataTable() {


            datatable.ajax.reload()
        }
    </script>
{% endblock %}