{% extends "layout.html" %}
{% block content %}

    <div class="row">
        <div class="col-md-12">
            <h1>{{ rows.subname }}</h1>
            {{ msg }}
            <table class="table">
                <thead>
                <td>Subject Code</td>
                <td>Subject Name</td>
                <td>Study Period</td>
                <td>Tutor</td>
                <td>Repeats</td>
                </thead>
                <tr>
                    <td>{{ rows["subcode"] }}</td>
                    <td>{{ rows["subname"] }}</td>
                    <td> {{ rows["studyperiod"] }}</td>
                    <td><a href="{{ url_for('view_tutor', tutorid = tutor["id"]) }}">{{ tutor["name"] }}</a></td>
                    <td><select id="repeats" onchange="changedvalue()">
                        {% for i in range(1,5) %}
                            {% if i == rows["repeats"] %}
                                <option selected>{{ i }}</option>
                            {% else %}
                                <option>{{ i }}</option>
                            {% endif %}
                        {% endfor %}
                    </select></td>

                </tr>
            </table>
            <a href="{{ url_for('remove_subject', subcode = rows["subcode"]) }}">
                <button class="button-delete">Delete {{ rows["subname"] }}</button>
            </a>
            {% if tutor != None %}
                        <a href="{{ url_for('remove_tutor_from_subject', subcode = rows["subcode"], tutorid = tutor["id"]) }}">
                            <button type="button" class="button-delete">Remove Tutor From Subject</button>
                        </a>{% endif %}
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            {% if tutor == None %}
                <h3>Add Tutor to Subject</h3>
                <form action="{{ url_for('add_tutor_to_subject', subcode = rows["subcode"]) }}" method="POST">
                    <select name="tutor">
                        {% for temptutor in tutors %}

                            <option value={{ temptutor["id"] }}>{{ temptutor["name"] }}</option>

                        {% endfor %}

                    </select>

                    <input type="submit" class="button" value="Add Tutor to Subject"/>
                </form>
                {{ msg2 }}
            {% endif %}
        </div>
    </div>








    <div class="row">
        <div class="col-md-12">
            <h1>Students Enrolled in this subject</h1>

            <table class="table" id="rolltable">
                <thead>
                <td>Student Number</td>
                <td>Name</td>
                <td>Scheduled Class</td>
                <td/>
                {% for class in classes %}
                    <td id="{{ class.id }}/date" class="week">Week <input type="number" value="{{ class.week }}"
                                                                          id="classweek/{{ class.id }}"
                                                                          style="width: 35px"
                                                                          onchange="changeClassTime({{ class.id }})"/><a
                            href='{{ url_for('delete_tutorial',tutorialid=class.id) }}'><img
                            src='../static/img/removeSymbol.png' class='deleteIcon'/></a>
                    </td>
                {% endfor %}
                </thead>

                {% for student in students %}
                    <tr>

                        <td id="studentid/{{ student.id }}">
                            <a href="{{ url_for('view_student', studentcode = student.studentcode) }}">{{ student["studentcode"] }}</a>
                        </td>
                        <td id="studentid/{{ student.id }}">
                            <a href="{{ url_for('view_student', studentcode = student.studentcode) }}">{{ student["firstname"] }} {{ student["lastname"] }}</a>
                        </td>
                        <td>{% for timeclass in rows.timetabledclasses %}
                            {% if student in timeclass.students %}
{{ timeclass.timeslot.day }} {{timeclass.timeslot.time }}
                            {% endif %}
                            {% endfor %}
                            </td>
                        <td>
                            <a href="{{ url_for('remove_student_from_subject', studentcode = student.studentcode, subcode = rows["subcode"]) }}"><img
                                    src='../static/img/removeSymbol.png' class='deleteIcon'/></a></a>
                        </td>
                        {% for class in classes %}
                            {% if student in attendees[class.id] %}
                                <td class="attended" id="{{ class.id }}/{{ student.id }}"
                                    onclick="updateStudentClassAttendance({{ class.id }},{{ student.id }},'{{ class.id }}/{{ student.id }}')"></td>
                            {% else %}
                                <td class="notattended" id="{{ class.id }}/{{ student.id }}"
                                    onclick="updateStudentClassAttendance({{ class.id }},{{ student.id }},'{{ class.id }}/{{ student.id }}')"></td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                {% endfor %}
            </table>

        </div>
        <button type="button" class="button" onclick="addNewClass()">Add a Class</button>
    </div>


    {% if tutor != None %}

        <div class="row">
            <div class="col-md-12">


                {% if subject.timetabledclasses == [] %}
                    <h1>Timetable Explorer</h1>
                    <h2>Student Availability</h2>
                <table class="table">
                    <thead>
                    {% for timeslot in timeslots %}
                        <td>{{ timeslot.day }} {{ timeslot.time }}</td>
                    {% endfor %}
                    </thead>
                    <tr>
                        {% for timeslot in timeslots %}
                            {% if  timeslot in times %}
                                <td class="attended"></td>
                            {% else %}
                                <td class="notattended"></td>
                            {% endif %}
                        {% endfor %}

                    </tr>


                </table>
            </div>
        </div>
            <h2>Tutor Availability</h2>
            <div class="row">
                <div class="col-md-6">
                    <table class="table">
                        <thead>
                        {% for row in timeslots %}
                            <td>{{ row.day }} {{ row.time }}</td>
                        {% endfor %}
                        </thead>
                        <tr>
                            {% for timeslot in timeslots %}
                                {% if timeslot in tutor.get_teaching_times() %}
                                    <td class="occupied"></td>
                                {% elif  timeslot in tutor.availabletimes %}
                                    <td class="attended"></td>
                                {% else %}
                                    <td class="notattended"></td>
                                {% endif %}
                            {% endfor %}
                        </tr>


                    </table>
                    <form action="{{ url_for('add_timetabledclass_to_subject', subcode = subject.subcode) }}"
                          method="POST">
                        <select name="timeslot">
                            {% for timeslot in timeslots %}

                                <option value={{ timeslot.id }}>{{ timeslot.day }} {{ timeslot.time }}</option>

                            {% endfor %}

                        </select>

                        <input type="submit" class="button" value="Timetable Class"/>
                    </form>
                </div>
            </div>
        {% else %}

                    <div class="row">
        <div class="col-md-6">
        <h1>Manage Student Class Allocation</h1>
<table class="table">
<thead>
<td>Student</td>
{% for timeclass in timetabledclasses %}
<td>{{ timeclass.timeslot.day }} {{ timeclass.timeslot.time }}<a href="{{ url_for('remove_timetabled_class_subject',timetabledclassid = timeclass.id) }}"><img src='../static/img/removeSymbol.png' class='deleteIcon' /></a></td>
{% endfor %}
</thead>
{% for student in rows.students %}
<tr>
<td>{{ student.name }}</td>
{% for timeclass in rows.timetabledclasses %}

{% if  student in timeclass.students %}

                            <td class="attended {{ student.id }}" id="slot/{{ timeclass.id }}/{{ student.id }}"
                                onclick="updateStudentScheduledClass({{ timeclass.id }},{{ student.id }},'slot/{{ timeclass.id }}/{{ student.id }}')"></td>
                    {% else %}
                            <td class="notattended {{ student.id }}" id="slot/{{ timeclass.id }}/{{ student.id }}"
                                onclick="updateStudentScheduledClass({{ timeclass.id }},{{ student.id }},'slot/{{ timeclass.id }}/{{ student.id }}')"></td>
                    {% endif %}
{% endfor %}
</tr>
{% endfor %}
</table>
         <form action="{{ url_for('add_timetabledclass_to_subject', subcode = subject.subcode) }}"
                          method="POST">
                        <select name="timeslot">
                            {% for timeslot in timeslots %}

                                <option value={{ timeslot.id }}>{{ timeslot.day }} {{ timeslot.time }}</option>

                            {% endfor %}

                        </select>

                        <input type="submit" class="button" value="Timetable Class"/>
                    </form>


        </div>

        {% endif %}
    {% endif %}

    {% if tutor != None %}


    {% endif %}

<div class="col-lg-6">
<h1>Attendance Rate</h1>
    <canvas id="SubjectAttendanceRate" height="250"></canvas>


</div>


</div>
    <script src="../static/js/Chart.bundle.js"></script>
    <script>

        var ctx = document.getElementById("SubjectAttendanceRate");


        function changedvalue() {
            var x = document.getElementById("repeats");
            var y = x.options[x.selectedIndex].text;
            $.ajax({
                url: "/updatesubjectrepeats",
                data: {subject: {{ rows.id }}, repeats: y},
                type: "POST",
                dataType: "json",
                success: function (data) {

                }
                ,
                error: function () {

                }
            });

        }


    function updateStudentScheduledClass(timeclassid, studentid, id) {

        $.ajax({
                url: "/updatestudentscheduledclassajax",
                data: {timeclassid: timeclassid, studentid: studentid},
                type: "POST",
                dataType: "json",
                success: function (data) {
                    var x = document.getElementById(id);
                    var y = document.getElementsByClassName(studentid);
                    if (x.className == "attended "+ studentid) {
                    } else if (x.className == "notattended " + studentid) {
                        for(i=0; i < y.length; i++) {
                        y[i].className = "notattended " + studentid;
                        }
                        x.className = "attended " + studentid;
                    }

                },
                error: function () {

                }
            });


        }

        function updateStudentClassAttendance(classid, studentid, id) {

            $.ajax({
                url: "/updatestudentclassattendanceajax",
                data: {classid: classid, studentid: studentid},
                type: "POST",
                dataType: "json",
                success: function (data) {
                    var x = document.getElementById(id);
                    if (x.className == "attended") {
                        x.className = "notattended";
                    } else if (x.className == "notattended") {
                        x.className = "attended";
                    }

                },
                error: function () {

                }
            });

        }

        function changeClassTime(classid) {
            var x = document.getElementById("classweek/" + classid);
            $.ajax({
                url: "/updateclasstimeajax",
                data: {classid: classid, week: x.value},
                type: "POST",
                dataType: "json",
                success: function (data) {
                },
                error: function () {

                }
            });

        }


        function addNewClass() {
            $.ajax({
                url: "/createnewclassajax",
                data: {subjectid: {{rows.id}}},
                type: "POST",
                dataType: "json",
                success: function (data) {
                    var tbl = document.getElementById('rolltable'), i;
                    for (i = 0; i < tbl.rows.length; i++) {
                        var trow = tbl.rows[i];
                        if (i == 0) {
                            var y = document.createElement('td');
                            y.innerHTML = "Week <input type='number' id='classweek/" + data + "' value='3' onchange ='changeClassTime(" + data + ")' style = 'width: 35px' /><a href='deletetutorial%3Ftutorialid%3D" + data + "'><img src='../static/img/removeSymbol.png' class='deleteIcon' /></a>"
                            trow.appendChild(y);
                        } else {
                            var studentid;
                            for (var j = 0; j < trow.cells.length; j++) {
                                if (trow.cells[j].getAttribute('id')) {
                                    studentid = trow.cells[j].getAttribute('id').split("/")[1];
                                    break;
                                }
                            }
                            ;
                            var x = document.createElement('td')
                            x.setAttribute('class', "notattended")
                            x.setAttribute('id', data + '/' + studentid)
                            x.setAttribute('onclick', "updateStudentClassAttendance(" + data + "," + studentid + ",'" + data + "/" + studentid + "')")
                            console.log(x.getAttribute('onclick'))
                            trow.appendChild(x)
                        }


                    }
                },
                error: function () {

                }
            });

        }
        var attendancedata = [];
        var attendancelabels = [];
        function getSubjectAttendanceData() {
            $.ajax({
                type: 'GET',
                url: '{{ url_for('get_subject_attendance_rate_ajax',subjectid = rows.id) }}',
                dataType: 'json',
                success: function (data) {
                    Object.keys(data).forEach(function (k) {
                        attendancelabels.push(k);
                    } );
                    attendancelabels.sort(function(a,b) {
                        a = parseInt(a.split(' ')[1])
                        b = parseInt(b.split(' ')[1])
                        return a-b
                    });
                    for(var k=0; k<attendancelabels.length; k++) {
                        attendancedata.push(data[attendancelabels[k]]["Attendance Rate"]);}
                    drawSubjectAttendanceChart();
                }
            });
        }

        function drawSubjectAttendanceChart() {
            var mySubjectAttendanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [ {
                        data: attendancedata,
                        label: "Attendance Rate",
                        fill: false,
                        backgroundColor: ["#3e95cd"],
                        borderColor: ["#3e95cd"]
                    }],
                    labels: attendancelabels
                },
                options: {}
            })
        }

        getSubjectAttendanceData()



    </script>

{% endblock %}